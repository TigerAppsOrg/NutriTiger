{% extends "layout.html" %}
{% set current_page = 'logfood' %}

{% block title %}Log Food{% endblock %} =
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.css" integrity="sha512-4OzqLjfh1aJa7M33b5+h0CSx0Q3i9Qaxlrr1T/Z+Vz+9zs5A7GM3T3MFKXoreghi3iDOSbkPMXiMBhFO7UBW/g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.js" integrity="sha512-f26fxKZJiF0AjutUaQHNJ5KnXSisqyUQ3oyfaoen2apB1wLa5ccW3lmtaRe2jdP5kh4LF2gAHP9xQbx7wYhU5w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!--Give header white background -->
<div id="loading-animation" class="loading-animation">
    <div class="loading-spinner"></div>
</div>


<style> 
    .icons .fa { 
        width: 50px; 
        height: 50px; 
        font-size: 50px; 
    } 
      
</style> 

<div class="text-center p-3">
    <h1 class="my-2">Log a Meal 
        <!--i button for instruction steps-->
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
        </svg>
    </h1>

    <p class="px-5">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-1-circle" viewBox="0 0 16 16">
            <path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M9.283 4.002V12H7.971V5.338h-.065L6.072 6.656V5.385l1.899-1.383z"/>
          </svg> <strong>Choose</strong> a dining hall from the drop down below. <br>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-2-circle" viewBox="0 0 16 16">
            <path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M6.646 6.24v.07H5.375v-.064c0-1.213.879-2.402 2.637-2.402 1.582 0 2.613.949 2.613 2.215 0 1.002-.6 1.667-1.287 2.43l-.096.107-1.974 2.22v.077h3.498V12H5.422v-.832l2.97-3.293c.434-.475.903-1.008.903-1.705 0-.744-.557-1.236-1.313-1.236-.843 0-1.336.615-1.336 1.306"/>
          </svg> <strong>Select</strong> your dish(es). <br>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-3-circle" viewBox="0 0 16 16">
            <path d="M7.918 8.414h-.879V7.342h.838c.78 0 1.348-.522 1.342-1.237 0-.709-.563-1.195-1.348-1.195-.79 0-1.312.498-1.348 1.055H5.275c.036-1.137.95-2.115 2.625-2.121 1.594-.012 2.608.885 2.637 2.062.023 1.137-.885 1.776-1.482 1.875v.07c.703.07 1.71.64 1.734 1.917.024 1.459-1.277 2.396-2.93 2.396-1.705 0-2.707-.967-2.754-2.144H6.33c.059.597.68 1.06 1.541 1.066.973.006 1.6-.563 1.588-1.354-.006-.779-.621-1.318-1.541-1.318"/>
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8"/>
          </svg> <strong>Enter</strong> the number of servings you consumed in the “My Plate” window. <br>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-4-circle" viewBox="0 0 16 16">
            <path d="M7.519 5.057q.33-.527.657-1.055h1.933v5.332h1.008v1.107H10.11V12H8.85v-1.559H4.978V9.322c.77-1.427 1.656-2.847 2.542-4.265ZM6.225 9.281v.053H8.85V5.063h-.065c-.867 1.33-1.787 2.806-2.56 4.218"/>
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8"/>
          </svg> <strong>Press</strong> the Upload Plate button to return to the homepage.
          
          <br><br>Please note that at this time only food items with nutritional information are displayed and able to be logged.
    </p>
    <button class="btn btn-primary" id="startTutorial">Click to see a tutorial.</button>
</div>

<script> 
    $(document).ready(function () { 
        $('[data-toggle="tooltip"]').tooltip({ 
            placement: 'bottom' 
        }); 
    }); 
</script> 

<div class="container-fluid">
    
    <!--Two cards: one for the dining hall food display, and one for My Plate-->
    <div class="row px-2">
        <div class="col-md-12 col-lg-6 p-3">
            <!--Putting entire food selection menu in one background card-->
            <div class="logfood-card card">
                <div class="col-md-8 p-3">
                    <select class="select-dropdown btn btn-secondary dropdown-toggle form-select custom-dropdown" id="diningHallSelect" aria-label="select_dhall" style="display: block;">
                        <option value="Select Food Source" selected>Select Food Source</option>
                        <option value="Center for Jewish Life">Center for Jewish Life</option>
                        <option value="Forbes College">Forbes College</option>
                        <option value="Graduate College">Graduate College</option>
                        <option value="Yeh & New West Colleges">Yeh & New West Colleges</option>
                        <option value="Rockefeller & Mathey Colleges">Rockefeller & Mathey Colleges</option>
                        <option value="Whitman & Butler Colleges">Whitman & Butler Colleges</option>
                        <option value="Personal Food Items">My Custom Foods</option>
                        <option value="USDA FoodData Central">Search for other foods</option>
                        <option hidden value="Example Dining Hall">Example Dining Hall</option>

                    </select>
                </div>
                <span class="col-10 col-sm-6 p-3" id = "searchBarSpan"  style="display: none;">
                    <input id="searchBar" type="text" class="form-control" placeholder='ex. "Green Apple..."' />
                </span>
            
                <div class="card-body">
                    <!-- Mealtime Tab Navs -->
                    <ul class="nav nav-tabs" id="mealTimeTab" role="tablist">
                        {% if not is_weekend_var: %}
                        <li class="custom-nav-item">
                            <a class="nav-link active" id="Breakfast-tab" data-toggle="tab" href="#breakfast" role="tab" aria-controls="breakfast" aria-selected="true">Breakfast</a>
                        </li>
                        <li class="custom-nav-item">
                            <a class="nav-link" id="Lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch" aria-selected="false">Lunch</a>
                        </li>
                        {% endif %} {% if is_weekend_var: %}
                        <li class="custom-nav-item">
                            <a class="nav-link active" id="Lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch" aria-selected="false">Brunch</a>
                        </li>
                        {% endif %}
                        <li class="custom-nav-item">
                            <a class="nav-link" id="Dinner-tab" data-toggle="tab" href="#dinner" role="tab" aria-controls="dinner" aria-selected="false">Dinner</a>
                        </li>
                    </ul>
                    <div class="card" style="min-height: 300px;">
                        <div class="card-body" id="usda-search-results"></div>
                        {% include 'logfood_update.html' %}
                        
                    </div>
                </div>
            </div>
        </div>
        <!--My Plate Card (right side)-->
        <div class="col-md-12 col-lg-6 p-3">
            <form action="/logfood" method="post">
            <div class="logfood-card card" id="tutorial-my-plate">
                <div class="card-body">
                    <h5 class="card-title text-center">My Plate</h5>
                    <p class="text-center">Select foods from the menu and add your estimated servings consumed.</p>
                    <div id="my-plate"></div>
                </div>
                <!--My Plate Footer: display plate macro totals-->
                <div class="card-footer text-center">
                    <strong>Plate Totals:</strong>
                    <br />
                    <div id="plateTotals"></div>
                </div>
            </div>
            <!--Upload plate button-->
            <div class="container p-5">
                <h5>Done adding food to your plate?</h5>
                
                    <button id="submitButton" type="submit" class="btn btn-primary btn-lg btn-block" name="upload_plate" onclick="closeForm(event)">Upload Plate and Return</button>
                
            </div>
        </form>
        </div>
    </div>
</div>
{% endblock %} {% block script %}
<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    // global variable for entry nutrition
    let entry_nutrition = { calories: 0, carbs: 0, fats: 0, proteins: 0 };

    // function to insert food-items into myplate from ajax call
    function handleMyPlate(data) {
        $("#my-plate").append(data);
        hideLoadingAnimation();
        handleServingChange();
    }

    function showLoadingAnimation() {
        // Show the loading animation covering the entire screen
        $("#loading-animation").show();
        $('input').keydown(function(e) {
            e.preventDefault();
            return false;
        });

        $('.introjs-nextbutton').keydown(function(e) {
            e.preventDefault();
            return false;
    });
    }

    function hideLoadingAnimation() {
        // Hide the loading animation
        $("#loading-animation").hide();
        $('input').off('keydown');
    }

    // function to handle removing a food-item from myplate
    function closeMyPlate(element) {
        let checkid = element.dataset.checkid;
        let checkbox = document.getElementById(checkid);
        if (checkbox) {
            checkbox.checked = false;
        }
        let myplateid = element.dataset.myplateid;
        let myplatebox = document.getElementById(myplateid);
        if (myplatebox) {
            myplatebox.remove();
        }
        handleServingChange();
    }

	function changeCheckbox(element) {
		if (element.checked) {
			element.checked = false
		} else {
			element.checked = true
		}
		handleCheckboxChange(element)
	}

    // Function to handle checkbox change event: gets label text, macro data, makes URL, and
    // sends AJAX GET request to server
    function handleCheckboxChange(element) {
        if (element.checked) {
            console.log("checked: ", element.dataset.mealname);
            let url =
                `/logfood/myplate?checkid=${encodeURIComponent(element.id)}` +
                `&mealname=${encodeURIComponent(element.dataset.mealname)}` +
                `&recid=${encodeURIComponent(element.dataset.recid)}` +
                `&location=${encodeURIComponent(element.dataset.location)}` +
                `&mealtime=${encodeURIComponent(element.dataset.mealtime)}` +
                `&servingsize=${encodeURIComponent(element.dataset.servingsize)}` +
                `&cals=${encodeURIComponent(element.dataset.cals)}` +
                `&carbs=${encodeURIComponent(element.dataset.carbs)}` +
                `&prots=${encodeURIComponent(element.dataset.prots)}` +
                `&fats=${encodeURIComponent(element.dataset.fats)}` +
                `&usda=${encodeURIComponent(element.dataset.usda)}`;

            let requestData = {
                type: "GET",
                url: url,
                success: handleMyPlate,
                error: handleError,
            };
            showLoadingAnimation();
            request = $.ajax(requestData);
        } else {
            let checkid = element.id;
            let uniqueid = checkid.slice(8);
            let myplatebox = document.getElementById("myplate-" + uniqueid);
            if (myplatebox) {
                myplatebox.remove();
            }
        }
        handleServingChange();
    }

    // for when AJAX Request encounters an error
    function handleError() {
        console.log("error");
        hideLoadingAnimation();
    }

    // function to insert food-items into the menu container
    function handleResponse(data) {
        $("#menu-items").html(data);
        hideLoadingAnimation();
    }

    // Function to handle USDA data search
    function searchUSDAFood() {
        const query = $("#searchBar").val().trim();
        // resultsContainer.children().hide(); // hide results if query is empty
        showLoadingAnimation();
        if (query != "") {
            fetch(`/logfood/usdadata?query=${encodeURIComponent(query)}`)
                .then((response) => response.json())
                .then((data) => {
                    console.log("append the response");
                    appendDataToDOM(data);
                })
                .catch((error) => console.error("Error fetching USDA data:", error));
        } else {
            appendDataToDOM({});
        }
    }

    function appendDataToDOM(data) {
        const resultsContainer = document.getElementById("usda-search-results");
        resultsContainer.innerHTML = ""; // Clear previous results - base saving on plate info

        if (data && data.length > 0) {
            data.forEach((food, index) => {
                const calories = food.calories || 0;
                const proteins = food.proteins || 0;
                const carbs = food.carbs || 0;
                const fats = food.fats || 0;

                // Check if food portions are available and extract the first one
                const servingSizeInfo = food.servingSize;

                const foodElement = document.createElement("div");
                foodElement.className = "form-check";
                console.log(food.fdcIc);
                foodElement.innerHTML = `
                <input type="checkbox" class="form-check-input" id="usda-checkbox-${food.recipeid}" data-usda="true" data-recid="${food.recipeid}"
                    data-mealname="${food.mealname}" data-location="USDA FoodData Central" data-mealtime="N/A" data-servingsize="${servingSizeInfo}" data-cals="${calories}"
                    data-carbs="${carbs}" data-prots="${proteins}" data-fats="${fats}"
                    onchange="handleCheckboxChange(this)" oncopy="disableCopyPaste(event) onpaste="disableCopyPaste(event) oncut="disableCopyPaste(event)">
                <label class="form-check-label" for="checkbox-${food.recipeid}">${food.mealname}</label>
                <p id="nf-${food.recipeid}">Serving Size: ${servingSizeInfo}, Calories: ${calories}, Proteins: ${proteins}g, Carbs: ${carbs}g, Fats: ${fats}g</p>
                `;  
                resultsContainer.appendChild(foodElement);
            });
        } else {
            resultsContainer.innerHTML = "<div>No results found.</div>";
        }
        hideLoadingAnimation();
    }

    function addUSDANutritionData() {
        let nutritionData = [];

        // Collect data from all checked USDA food checkboxes
        document.querySelectorAll(".small-input").forEach((input) => {
            if (input.dataset.usda === "true") {
                let foodData = {
                    recipeid: input.dataset.recid,
                    mealname: input.dataset.mealname,
                    servingsize: input.dataset.servingsize,
                    calories: parseFloat(input.dataset.cals),
                    proteins: parseFloat(input.dataset.prots),
                    carbs: parseFloat(input.dataset.carbs),
                    fats: parseFloat(input.dataset.fats),
                    source: "usda",
                };
                nutritionData.push(foodData);
            }
        });

        // Send the data to the server if there is any
        if (nutritionData.length > 0) {
            showLoadingAnimation();
            $.ajax({
                url: "/addingnutrition", // URL to the server-side function handling the database insertion
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ nutritionData: nutritionData }),
                success: function (response) {
                    console.log("Nutrition data successfully sent and saved:", response);
                    // alert("Nutrition data added successfully!");
                },
                error: function (xhr, status, error) {
                    console.error("Failed to send nutrition data:", error);
                    // alert("Error adding nutrition data. Check console for details.");
                },
            });
        } else {
            console.log("No USDA food items selected or data is missing.");
            // alert("No USDA food items selected or data is incomplete.");
        }
    }

    // Debounce function to limit rate of invoking functions
    function debounce(func, delay) {
        let debounceTimer;
        return function () {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // fetch menu items based on selected dhall and mealtime + correct display
    function getResults() {
        $(".menu-items-content").hide();
        $("#menu-items").show();
        $("#select").hide();
        $("#noDataMessage").hide();
        let selectedHall = $("#diningHallSelect").val();

        if (selectedHall === "Personal Food Items") {
            console.log("selected hall is personal")
            $("#searchBarSpan").hide();
            $("#mealTimeTab").hide();
            $("#usda-search-results").hide();
            $("#personal-food-items").show();
            $("#tutorial-food-items").hide();
            $("#menu-items").hide();

        } else if (selectedHall === "USDA FoodData Central") {
            $("#mealTimeTab").hide();
            $("#searchBarSpan").show();
            $("#usda-search-results").show();
            $("#personal-food-items").hide();
            $("#tutorial-food-items").hide();
            $("#menu-items").hide();

        } 
        else if (selectedHall === "Example Dining Hall") {
            $("#usda-search-results").hide();
            $("#personal-food-items").hide();
            $("#tutorial-food-items").show();
            $("#menu-items").hide();

        } 
        else {
            $("#searchBarSpan").hide();
            $("#usda-search-results").hide();
            $("#personal-food-items").hide();
            $("#tutorial-food-items").hide();
            $("#menu-items").show();


            $("#mealTimeTab").show();
            let mealtime = $(".nav-tabs .active").attr("id").replace("-tab", "");
            dhallCode = selectedHall.substring(0, 2);
            let divToShow = dhallCode + "-" + mealtime;
            if ($("#" + divToShow).length > 0) {
                $("#" + divToShow).show();
            } 
            else {
                $("#noDataMessage").show();
            }
        }
    }

    function handleServingChange() {
        const inputs = document.querySelectorAll(".small-input");
        let totalCals = 0;
        let totalCarbs = 0;
        let totalFats = 0;
        let totalProts = 0;
        inputs.forEach((input) => {
            input.setCustomValidity('');
            customCheckValidity(input)
            let serving = input.value;
            totalCals += serving * input.dataset.cals;
            totalCarbs += serving * input.dataset.carbs;
            totalFats += serving * input.dataset.fats;
            totalProts += serving * input.dataset.prots;
        });
        entry_nutrition["calories"] = totalCals;
        entry_nutrition["carbs"] = totalCarbs;
        entry_nutrition["fats"] = totalFats;
        entry_nutrition["proteins"] = totalProts;

        const plateTotals = document.getElementById("plateTotals");
        plateTotals.innerHTML = `Calories: ${totalCals.toFixed(2)} Proteins: ${totalProts.toFixed(2)} Carbs: ${totalCarbs.toFixed(2)} Fats: ${totalFats.toFixed(2)} `;
    }

    function customCheckValidity(input) {
        let isValid = true;
        inputValue = parseFloat(input.value)
        // Check if the input is empty
        if (!input.value || input.value==0) {
            input.setCustomValidity("Please fill out a non-zero serving size."); // Set custom message
            isValid = false;
        }
        else if (inputValue > 100) {
            input.setCustomValidity("Serving size must be less than or equal to 100."); // Set custom message
            isValid = false;
        } else {
            input.setCustomValidity(""); // Clear any previous custom validity messages
        }
        input.reportValidity();
        return isValid;
    }

    function validateInputs(event) {
        const inputs = document.querySelectorAll(".small-input");
        valid = true;

        // Check if there are 0 food items selected
        if (inputs.length == 0) {
            alert('Please add foods to your plate before submitting.')
            event.preventDefault()
            return false;
        }

        inputs.forEach((input) => {
            if (!customCheckValidity(input)) {
                valid=false
            }
        });
        return valid
    }

    function startTutorial() {
        var element = document.getElementById("navbar");
        element.style.zIndex = "0";

    introJs().setOptions({
        disableInteraction: true,
        showBullets: false,
        showProgress: true,
        tooltipClass: 'customTooltip',
        steps: [{
            title: 'Welcome',
            intro: 'Welcome to the tutorial to learn how to log your food for the day!'
        }, {
            title: 'Select a source',
            element: document.querySelector('.select-dropdown'),
            intro: "First, you will select the source of your food here. This can be from Princeton's dining halls, your custom recipes, or from a generic USDA database if you can't find it. We have picked a dining hall for you for this demonstration."
        }, {
            title: 'Select Mealtime',
            element: document.querySelector('#mealTimeTab'),
            intro: 'Here you can select your mealtime!'
        }, {
            title: 'Select Foods',
            element: document.querySelector('#tutorial-food-items'),
            intro: 'And here you can select the foods based on the pre-selected dining hall and mealtime.'
        }, {
            title: 'Select Item',
            element: document.querySelector('#checkbox-tutorial-1'),
            intro: "Let's select an item as an example."
        }, {
            title: 'Edit My Plate',
            element: document.querySelector('#tutorial-my-plate'),
            intro: "Once you select an item, it appears here where you can edit the servings, or delete it if you accidentally added it. By default, a serving size of 1 is put, but this can easily be changed."
        }, {
            title: 'Plate Totals',
            element: document.querySelector('.card-footer'),
            intro: "You can also see running totals of calories, proteins, carbs, and fats that update with each food you add to your plate."
        }, {
            title: 'Generic Food Search',
            element: document.querySelector('#searchBarSpan'),
            intro: "Let's go add another food. This time, let's search through the USDA's generic food database for a banana. While it processes your request, a loading animation is shown."
        }, {
            title: 'Generic Food Selection',
            element: document.querySelector('#usda-search-results'),
            intro: "Here are all the relevant results. Let's check another thing off again."
        }, {
            title: 'Edit My Plate',
            element: document.querySelector('#tutorial-my-plate'),
            intro: "Notice how it appeared in my plate and the serving size is one by default. Again, notice how plate totals have also been updated to reflect the new foods in your plate."
        }, {
            title: 'Upload plate',
            element: document.querySelector('#submitButton'),
            intro: "Finally, once you are done adding items and editing servings, you can upload your plate and return to the homepage where it will appear."
        }, ]
    }).onafterchange(function(targetElement) {
        var nextButton = document.getElementsByClassName("introjs-nextbutton")

        nextButton.style.pointerEvents = "none"
    }).onchange(function(targetElement) {
        
        // Check if we are on the step where we want to auto-select an option from the dropdown
        if (targetElement.classList.contains('select-dropdown')) {
            // Simulate selecting an option by triggering a change event
            document.querySelector('.select-dropdown').value = 'Example Dining Hall';
            document.querySelector('.select-dropdown').dispatchEvent(new Event('change'));
        }
        if (targetElement.id == 'checkbox-tutorial-1') {
            var checkbox = document.querySelector('#checkbox-tutorial-1');
            checkbox.checked = true;
            handleCheckboxChange(checkbox);
        }
        if (targetElement.id == 'searchBarSpan') {
            document.querySelector('.select-dropdown').value = 'USDA FoodData Central';
            document.querySelector('.select-dropdown').dispatchEvent(new Event('change'));
            var searchBar = document.getElementById("searchBar");
            searchBar.value = "banana";
            searchUSDAFood();
            
        }
        if (targetElement.id == 'usda-search-results') {
            var checkbox = document.getElementById("usda-checkbox-usda-2012128");
            checkbox.checked = true;
            handleCheckboxChange(checkbox);
        }
    }).onexit(function() {
        var navbar = document.getElementById("navbar");
        navbar.style.zIndex = "1030";
        document.querySelector('.select-dropdown').value = 'Select Food Source';
        document.querySelector('.select-dropdown').dispatchEvent(new Event('change'));
        document.getElementById('close--tutorial-1').click();
        document.getElementById('close-ckbox-usda-2012128').click();
        var searchBar = document.getElementById("searchBar");
        searchBar.value = "";
        var usdaSearchResults = document.getElementById('usda-search-results');
        usdaSearchResults.innerHTML = '';
       
    }).start();
}

    // When the user submits the form and all fields are valid, lock it
    function closeForm(e) {
        // Obtain form elements
        const inputs = document.querySelectorAll(".small-input");

        inputs.forEach((input) => {
            input.value = parseFloat(input.value).toFixed(2)
        });

        var validFormElements = document.querySelectorAll(".small-input:valid")
        var logFoodButton = document.getElementById("submitButton")

        if (validFormElements.length == inputs.length) {
            logFoodButton.style.pointerEvents = "none"
            logFoodButton.textContent = "Submitting..."
            logFoodButton.style.opacity = "var(--bs-btn-disabled-opacity)"
        }
    }

    // If the user hits the back button reset the form
    window.onunload = function() {
        hideLoadingAnimation();
        var logFoodButton = document.getElementById("submitButton");
        var dropdown = document.querySelector('.select-dropdown');

        calorieInput.readOnly = false;
        logFoodButton.style.pointerEvents = "auto";
        logFoodButton.textContent = "Upload Plate and Return";
        logFoodButton.style.opacity = "none";
        dropdown.value = "Select Food Source";
        //dropdown.selectedIndex = 0
        dropdown.dispatchEvent(new Event('change'));
    }

    // set up event listeners for dhall select and mealtime tab
    function setup() {
        $("#menu-items").show();
        hideLoadingAnimation();

        document.getElementById("startTutorial").addEventListener("click", function () {
            startTutorial();
        });

        $("#diningHallSelect").change(getResults); // Toggle search bar on selection change
        $("#searchBar").on("input", debounce(searchUSDAFood, 1000)); // Debounce the search input
        const diningHallSelect = document.getElementById("diningHallSelect");

        // Event listener for the dropdown selection change
        $("#mealTimeTab a").on("shown.bs.tab", getResults);
        diningHallSelect.addEventListener("change", getResults);

        // Event listener for submit button (to get entry and send to flask)
        document.getElementById("submitButton").addEventListener("click", function (event) {
            event.preventDefault();
            addUSDANutritionData();

            // validation
            if (!validateInputs(event)) {
                event.preventDefault()
                return false;
            }

            var recids = [];
            var servings = [];
            const inputs = document.querySelectorAll(".small-input");
            inputs.forEach((input) => {
                let recid = input.dataset.recid;
                let serving = parseFloat(input.value);
                recids.push(recid);
                servings.push(serving);
            });

            var dataToSend = {
                entry_recids: recids,
                entry_servings: servings,
                entry_nutrition: entry_nutrition,
            };
            var jsonData = JSON.stringify(dataToSend);
            showLoadingAnimation();
            $.ajax({
                type: "POST",
                url: "/logfood",
                contentType: "application/json",
                data: jsonData,
                success: function (response) {
                    // Check if the server response includes the redirect URL
                    if (response.success && response.redirect) {
                        // Hide the loading animation before redirection

                        window.location.href = response.redirect;
                        // Delay the redirection slightly to ensure the loading animation is hidden
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error in data submission:", xhr.status, xhr.responseText);
                },
            });
        });
    }

    $("document").ready(setup);
</script>
{% endblock %}
