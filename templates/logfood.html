<!--==============================================================-->
<!-- logfood.html                                                   -->
<!--==============================================================-->

<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Log Food</title>
    {% include 'bootstrap.html' %}
</head>


<body>
    {% include 'navbar.html' %}
    {% set current_page = 'logfood' %}

    <h1 class="text-center m-5">Log Food</h1> 
    <p class="custom-text-wrapper">
        Select your dining hall from the drop down below or search for the recipe name in the 
        search bar. Once you select your dish(es), estimate the number of servings you consumed 
        in the “My Plate” window below. 
    </p>
    
    <!-- Select buttons: Dining Hall, Mealtime -->
    <div class="row p-2">
        <div class="col-sm-3 m-3">
            <select class="form-select form-select-sm" id = "diningHallSelect" aria-label="select_dhall" style="background-color: rgb(250, 160, 58);">
              <option value="Select Dining Hall" selected>Select Dining Hall</option>
              <option value="Center for Jewish Life">Center for Jewish Life</option>
              <option value="Forbes College">Forbes College</option>
              <option value="Graduate College">Graduate College</option>
              <option value="Yeh & New West Colleges">Yeh & New West Colleges</option>
              <option value="Rockefeller & Mathey Colleges">Rockefeller & Mathey Colleges</option>
              <option value="Whitman & Butler Colleges">Whitman & Butler Colleges</option>
              <option value="Personal Foods">Personal Foods</option>
            </select>
        </div>
    </div>

    <!--Two cards: one for the food list, and one for My Plate-->
    <div class="row p-2">
      <div class="col-md-6 m-3">
        <!-- Tab Navs -->
        <ul class="nav nav-tabs" id="mealTimeTab" role="tablist">
          {% if not is_weekend_var: %}
            <li class="custom-nav-item">
              <a class="nav-link active" id="Breakfast-tab" data-toggle="tab" href="#breakfast" role="tab" aria-controls="breakfast" aria-selected="true">Breakfast</a>
            </li>
            <li class="custom-nav-item">
              <a class="nav-link" id="Lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch" aria-selected="false">Lunch</a>
            </li>
          {% endif %}
          {% if is_weekend_var: %}
            <li class="custom-nav-item">
              <a class="nav-link active" id="Lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch" aria-selected="false">Brunch</a>
            </li>
          {% endif %}
          
          <li class="custom-nav-item">
              <a class="nav-link" id="Dinner-tab" data-toggle="tab" href="#dinner" role="tab" aria-controls="dinner" aria-selected="false">Dinner</a>
          </li>
        </ul>


        <div class="card">
          <div class="card-body" id="menu-items">
            <p class="text-center">Please select a dining hall from the dropdown menu.</p>
          </div>
        </div>

      </div>

      <!--My Plate Card (right side)-->
      <div class="col-sm-5 m-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title text-center">My Plate</h5>
            <p class="text-center">Select foods from the menu and add your estimated servings consumed.</p>
            <div id="my-plate"></div>
          </div>

          <!--My Plate Footer: display plate totals-->
          <div class="card-footer text-center">
            <strong>Plate Totals:</strong>
            <br>
            <div id="calTotal"> 
            </div>
            <div id="protTotal"> 
            </div>
            <div id="carbTotal"> 
            </div>
            <div id="fatTotal"> 
            </div>
          </div>

        </div>
      </div>
    </div>
    
    <div class="container p-5">
      <h4>Done adding food to your plate?</h4>
      <form action="/logfood" method="post" class="p-3">
        <button type="submit" class="btn btn-primary btn-lg btn-block" name="upload_plate">Upload Plate and Return</button>
      </form>
    </div>

</body>
<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>

// storing checkbox state
var checkboxState = {};

// update checkbox status
function updateCheckboxState(recid, status) {
  checkboxState[recid] = status;
}

// set checkbox state based on stored state
function setCheckboxState(recid) {
    const checkbox = document.getElementById("checkbox-" + recid);
    if (checkboxStates.hasOwnProperty(recid)) {
        checkbox.checked = checkboxState[recid];
    }
}

// Function to setup checkbox states for all checkboxes on the page
function setupCheckboxStates() {
    // Loop through checkboxes and set their states
    const checkboxes = document.querySelectorAll('[id^="checkbox-"]');
    checkboxes.forEach(function(checkbox) {
        // get the recid substring from the id
        const recid = checkbox.id.replace("checkbox-", "");
        setCheckboxState(recid);
    });
}

// When AJAX request to add meal to plate is successful, append data to my-plate
function handleMyPlate(data) {
  console.log(data);
  $('#my-plate').append(data);
}

// Function to handle checkbox change event: gets label text, macro data, makes URL, and 
// sends AJAX GET request to server
function handleCheckboxChange(recid) {
  const check_id = "checkbox-"+recid;
  const checkbox = document.getElementById(check_id);
  const checked = checkbox.checked;
  if (checked) {
    // update checkbox state to CHECKED
    updateCheckboxState(recid, checked);

    console.log(recid)
    // Find the associated label element
    const label = document.querySelector('label[for="' + check_id + '"]');
    const labelText = label.textContent;
    const this_cals = document.getElementById("cals-" + recid).innerText;
    const this_prots = document.getElementById("prots-" + recid).innerText;
    const this_carbs = document.getElementById("carbs-" + recid).innerText;
    const this_fats = document.getElementById("fats-" + recid).innerText;
    console.log(labelText, this_cals, this_prots, this_carbs, this_fats);
    let url = `/logfood/myplate?mealname=${encodeURIComponent(labelText)}&cals=${encodeURIComponent(this_cals)}&prots=${encodeURIComponent(this_prots)}&carbs=${encodeURIComponent(this_carbs)}&fats=${encodeURIComponent(this_fats)}`;
        $.ajax({
            type: 'GET',
            url: url,
            success: handleMyPlate,
            error: handleError
        });

  }
  else {
    // update checkbox state to UNCHECKED
    updateCheckboxState(recid, unchecked);
    console.log('unchecked');
  }
}

// for when AJAX Request encounters an error
function handleError() {
  console.log('error');
}

// request fetch menu items (AJAX request)
function handleResponse(data) {
  console.log(data);
  $('#menu-items').html(data);
}

// fetch menu items based on selected dhall and mealtime
function getResults() {
    const diningHallSelect = $('#diningHallSelect');
    const menuItems = $('#menu-items');
    const selectedHall = diningHallSelect.val();

    if (selectedHall === "Select Dining Hall") {
        menuItems.html('<p class="text-center">Please select a dining hall from the dropdown menu.</p>');
    } else {
        const mealTimeTabs = $('#mealTimeTab');
        var mealtime = $('.nav-tabs .active').attr('id').replace('-tab', '');
        console.log("Selected dining hall:", selectedHall, "Mealtime:", mealtime);
        let url = `/logfood/data?dhall=${encodeURIComponent(selectedHall)}&mealtime=${encodeURIComponent(mealtime)}`;

        let requestData = {
            type: 'GET',
            url: url,
            success: handleResponse,
            error: handleError
        };
        request = $.ajax(requestData);
    }
}

// set up event listeners for dhall select and mealtime tab
function setup() {
  // Event listener for the dropdown selection change
  const diningHallSelect = document.getElementById('diningHallSelect');
  $('#mealTimeTab a').on('shown.bs.tab', getResults);
  diningHallSelect.addEventListener('change', getResults);

  setupCheckboxStates();
}

$('document').ready(setup);
</script>
</html>