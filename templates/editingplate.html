{% extends "layout.html" %}
{% set current_page = 'editingplate' %}
{% block title %}My Homepage{% endblock %}
{% block content %}
    <h1 class="text-center m-3">Editing My Plate</h1> 
    <h3 class="text-center m-3 text-muted">Good {{ampm}}, {{netid}}.</h3>

    <!--Layout for the two main cards-->
    <div class="row p-5">
        <div class="col-sm-9 mx-auto">
          <div class="card">
            <div class="card-body">

                <!--My Plate (right card)-->
                <h4 class="text-center py-3">My Plate</h4>

                <!--Create a card for each entry-->
                <div class="col">
                    {% for entry, foods in entries_food_dict.items() %}
                    <div class="row-cols-1 p-2">
                        <div class="entryCard card border-primary" id="{{ entry }}" style="padding: 10px;">
                            <div class="card-body">
                                <div class="header-container">
                                    <h5 class="card-title py-1">Entry {{ entry }}</h5>
                                    <form action="/editingplate" method="post">
                                        <input type="hidden" name="card_id" value="{{ entry }}">
                                        <button id="{{ entry }}" type="submit" data-entryId="{{ entry }}" class="entryCloseBtn btn-close" aria-label="Close"></button>
                                    </form>
                                </div>

                                <!--Create a bordered element for each food in the entry-->
                                <ul class="list-group">
                                    {% for food in foods %}
                                    <!--Border with close buttons for each food-->
                                    <div class="foodCard card border-primary p-2 mb-3" id="{{ loop.index }}">
                                        <div class="row">
                                            <div class="col">
                                                <!-- Food name label-->
                                                <span>{{ food }}</span>
                                            </div>
                                            <div class="col-auto d-flex align-items-center">
                                                <!-- Serving Lineedit Column and Close button -->
                                                <div id="new_entry" class="d-flex align-items-center">
                                                    <!-- Serving Lineedit -->
                                                    <input type="number" min="0" class="form-control small-input mr-2" data-cals="{{ cals }}"
                                                    data-recid="{{ recid }}" data-carbs="{{ carbs }}" data-fats="{{ fats }}" data-prots="{{ prots }}"
                                                    placeholder="Servings" oninput="handleServingChange()" required
                                                    onkeypress="return isValid(event)">
                                    
                                                    <!-- Close button -->
                                                    <button type="button" id="close-{{ uniqueid }}" class="foodCloseBtn btn btn-close btn-sm" aria-label="Close"
                                                    data-checkid="{{ checkid }}" data-myplateid="myplate-{{ uniqueid }}" data-foodId="{{ loop.index0 }}"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </ul>

                            </div>                             
                        </div>
                    </div>

                {% endfor %}

                <!--Save plate button-->
                <div class="py-3">
                    <form action="/editingplate" method="post">
                        <button id="savePlate" type="submit" name="save_plate" class="btn btn-secondary btn-lg btn-block">Save Plate</button>
                    </form>
                </div>
                
            </td>

        </tr>
    </table>

    <script>

        // List of deleted entries' indices
        let deletedEntries = [];
        // List of lists of deleted foods & their entries
        let deletedFoods = [];

        // pass in "Entry _" string
        function appendEntrytoDelete(entryId) {
            
            // Get index of entry from entry index
            var entryIndex = parseInt(entryId);
            console.log("The entry index appended is:", entryIndex);
            // append to deletedEntriesList
            deletedEntries.push(entryIndex);
        }

        function appendFoodtoDelete(entryId, foodId) {

            // make entryId an index (0-indexed already)
            var entryIndex = parseInt(entryId);
            var foodIndex = parseInt(foodId);
            console.log("The food index to delete:", foodIndex);

            // append to deleted foods list at the index that corresponds to its entry
            deletedFoods.push({index: entryIndex, foods: [foodId]});
        }

        // once an entry has been appended to be deleted, hide it from view
        function hideEntry(entryId) {
            document.getElementById(entryId).style.display = "none";
        }

        // once an entry has been appended to be deleted, hide it from view
        function hideFood(foodCardId) {
            document.getElementById(foodCardId).style.display = "none";
        }

        // Serving input validation function
        function isValid(input) {
            var charCode = input.which || input.keyCode;
            var value = input.target.value;
        
            // If the pressed key is a '-'
            if (input.charCode === 45)
                return false;
        
            // If the key contains nonvalid chars 
            if ((input.charCode < 48 || input.charCode > 57) && input.charCode !== 46)
                return false;
        
            // Allow only 2 decimal places
            if (value.indexOf('.') !== -1 && value.length - value.indexOf('.') > 2)
                return false;
        
            return true;
        }

        // select all Entry cards and add close button event listeners for each
        var entryCards = document.querySelectorAll('.entryCard');

        entryCards.forEach(function(card) {

            //add event listener to each food close button
            var foodCloseButtons = card.querySelectorAll('.foodCloseBtn');
            foodCloseButtons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    console.log("delete food button clicked");

                    var foodId = parseInt(button.dataset.foodId);
                    var entryId = card.id;
                    
                    // get id of the food card "parent"
                    var foodCard = button.closest('.foodCard'); // Find the closest food card element
                    var foodCardId = foodCard.id;
                    var foodCardIndex = foodCard.id - 1; // Get the ID of the food card

                    console.log("foodcard id is ", foodCardIndex);

                    // append 0-indexed indices for deleted food
                    appendFoodtoDelete(entryId, foodCardIndex);
                    hideFood(foodCardId);
                })
            });

            // add event listener to each entry close button
            var entryCloseButtons = card.querySelectorAll('.entryCloseBtn');
            entryCloseButtons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    console.log("Del entry button clicked");

                    var entryId = parseInt(button.dataset.entryId) - 1;
                    // append to list and hide from view
                    console.log("Printing entryid", entryId)
                    appendEntrytoDelete(entryId);
                    console.log("The deleted entry index is:", entryId);
                    hideEntry(entryId); 
                });
            });
        });
        
        // once submit button is clicked, send everything to be deleted as an AJAX call
        document.getElementById('savePlate').addEventListener('click', function(event) {
	    
	        console.log("save plate button clicked");
            console.log(deletedEntries)
            // Send AJAX request with everything to delete
            $.ajax({
                url: '/editingplate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ "deletedEntries": deletedEntries, "deletedFoods": deletedFoods }),
                success: function(response) {
                    console.log('Data sent successfully:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Error sending data:', error);
                }
            });
        });
    </script>
{% endblock %}